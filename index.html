<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Things To Do Nearby</title>
  <meta name="theme-color" content="#0b5fff" />
  <style>
    :root{
      --bg:#0b0c10;
      --card:#12141a;
      --ink:#e9eefb;
      --muted:#a7b1c2;
      --brand:#0b5fff;
      --accent:#14cba8;
      --danger:#ff4757;
      --chip:#1a2233;
      --border:#1f2533;
      --shadow: 0 6px 20px rgba(0,0,0,0.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg,#0a0b10 0%, #0b0c10 60%) fixed;
      color:var(--ink);
      font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    header{
      position:sticky; top:0; z-index:100;
      background:rgba(10,11,16,0.8); backdrop-filter:saturate(1.4) blur(12px);
      border-bottom:1px solid var(--border);
    }
    .bar{
      display:flex; align-items:center; gap:12px;
      padding:14px 16px;
    }
    .title{
      font-weight:700; letter-spacing:.2px; font-size:18px;
    }
    .tagline{ color:var(--muted); font-size:12px; }
    .controls{
      display:flex; gap:10px; padding:10px 16px 14px; flex-wrap:wrap; border-top:1px solid var(--border);
    }
    .chip{
      border:1px solid var(--border);
      background:var(--chip);
      color:var(--ink);
      padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none;
      font-weight:600; font-size:14px;
      transition:all .15s ease;
    }
    .chip:hover{ border-color:#2b3750 }
    .chip.active{ background:var(--brand); border-color:transparent; color:white; }
    .row{ display:flex; gap:10px; width:100%; }
    .row > *{ flex:1 }
    input, select, button{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--border);
      background:#0f121a; color:var(--ink); outline:none; transition:border-color .15s ease, background .2s ease;
      font-weight:600;
    }
    input::placeholder{ color:#6a7385; font-weight:500; }
    button.primary{ background:var(--brand); border-color:transparent; color:white; }
    button.secondary{ background:#121826; }
    button:active{ transform: translateY(1px) }
    main{ padding:14px 16px 80px; max-width:900px; margin:0 auto; }
    .hint{ color:var(--muted); font-size:13px; margin:6px 2px 12px }
    .results-meta{ color:var(--muted); font-size:13px; margin:8px 2px 14px }
    .cards{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width:740px){
      .cards{ grid-template-columns:1fr 1fr }
    }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; display:flex; gap:12px; align-items:flex-start;
    }
    .avatar{
      width:46px; height:46px; border-radius:12px; flex:0 0 46px;
      display:grid; place-items:center; font-weight:800; color:white;
      background:linear-gradient(135deg, var(--brand), #7b5cff);
    }
    .content{ flex:1; min-width:0 }
    .name{ font-weight:800; letter-spacing:.2px; }
    .meta{ color:var(--muted); font-size:13px; margin-top:4px }
    .badges{ display:flex; gap:6px; margin-top:8px; flex-wrap:wrap }
    .badge{
      background:#0e1726; border:1px solid #243049; color:#c6d3ee;
      padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700;
    }
    .actions{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap }
    .btn{
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
      padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0f1420;
      color:var(--ink); font-weight:700; text-decoration:none; cursor:pointer;
    }
    .btn.primary{ background:var(--brand); color:white; border-color:transparent }
    .empty, .error{
      background:#0f121a; border:1px dashed #2a3243; border-radius:14px; padding:18px; color:#b9c3d8;
    }
    .loader{
      display:inline-flex; align-items:center; gap:10px; color:#c9d7ff; font-weight:700;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--brand); animation:bounce 1s infinite alternate }
    .dot:nth-child(2){ animation-delay:.2s } .dot:nth-child(3){ animation-delay:.4s }
    @keyframes bounce{ to{ transform: translateY(-6px); opacity:.7 } }
    footer{
      position:fixed; bottom:0; left:0; right:0; padding:10px 12px; background:linear-gradient(180deg, rgba(10,11,16,0) 0%, rgba(10,11,16,.85) 30%, rgba(10,11,16,.95) 100%);
      display:flex; gap:8px; justify-content:center; flex-wrap:wrap; border-top:1px solid var(--border);
    }
    .pill{ padding:6px 10px; border-radius:999px; background:#101621; color:#d7e1f7; border:1px solid #22314a; font-size:12px; }
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;}
    .small{ font-size:12px; color:#9db0d8 }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div>
        <div class="title">Things To Do Nearby</div>
        <div class="tagline">Find cinemas, restaurants, and kid-friendly spots around you</div>
      </div>
    </div>
    <div class="controls">
      <div class="chip active" data-category="movies">Movies</div>
      <div class="chip" data-category="restaurants">Restaurants</div>
      <div class="chip" data-category="kids">Kids</div>
      <div class="chip" data-category="all">All</div>
      <div class="row">
        <select id="radius">
          <option value="1000">1 km</option>
          <option value="2000">2 km</option>
          <option value="3000" selected>3 km</option>
          <option value="5000">5 km</option>
          <option value="10000">10 km</option>
        </select>
        <button class="secondary" id="useLocation">Use my location</button>
      </div>
      <div class="row">
        <input id="address" placeholder="Or type an address, city, or landmark" />
        <button class="primary" id="searchAddress">Find</button>
      </div>
    </div>
  </header>

  <main>
    <div class="hint">Tip: Tap a category, set a radius, then use your location or enter an address.</div>
    <div id="status"></div>
    <div class="results-meta" id="meta"></div>
    <div class="cards" id="results"></div>
  </main>

  <footer>
    <div class="pill">Powered by OpenStreetMap via Overpass API</div>
    <div class="pill">No sign-in or API keys required</div>
  </footer>

  <script>
    // --- State ---
    const state = {
      lat: null,
      lon: null,
      category: 'movies',
      radius: 3000, // meters
      lastQueryTime: null
    };

    // --- Elements ---
    const chips = [...document.querySelectorAll('.chip')];
    const radiusEl = document.getElementById('radius');
    const useLocationBtn = document.getElementById('useLocation');
    const addressEl = document.getElementById('address');
    const searchAddressBtn = document.getElementById('searchAddress');
    const resultsEl = document.getElementById('results');
    const metaEl = document.getElementById('meta');
    const statusEl = document.getElementById('status');

    // --- Category definitions mapped to OSM tags ---
    const CATEGORIES = {
      movies: [
        { k:'amenity', v:'cinema' }
      ],
      restaurants: [
        { k:'amenity', v:'restaurant' },
        { k:'amenity', v:'fast_food' },
        { k:'amenity', v:'cafe' }
      ],
      kids: [
        { k:'leisure', v:'playground' },
        { k:'tourism', v:'theme_park' },
        { k:'tourism', v:'zoo' },
        { k:'tourism', v:'aquarium' },
        { k:'amenity', v:'community_centre' }
      ],
      all: [
        // A broader "things to do" sweep
        { k:'amenity', v:'cinema' },
        { k:'amenity', v:'restaurant' },
        { k:'amenity', v:'fast_food' },
        { k:'amenity', v:'cafe' },
        { k:'amenity', v:'bar' },
        { k:'amenity', v:'pub' },
        { k:'amenity', v:'nightclub' },
        { k:'leisure', v:'playground' },
        { k:'leisure', v:'park' },
        { k:'tourism', v:'theme_park' },
        { k:'tourism', v:'zoo' },
        { k:'tourism', v:'aquarium' },
        { k:'tourism', v:'viewpoint' }
      ]
    };

    // Alternate Overpass endpoints for resiliency
    const OVERPASS_ENDPOINTS = [
      'https://overpass-api.de/api/interpreter',
      'https://overpass.kumi.systems/api/interpreter',
      'https://overpass.openstreetmap.ru/api/interpreter'
    ];

    // --- Utilities ---
    function setStatus(html){
      statusEl.innerHTML = html || '';
    }
    function clearResults(){
      resultsEl.innerHTML = '';
      metaEl.textContent = '';
    }
    function formatDistance(m){
      if (m < 1000) return `${Math.round(m)} m`;
      return `${(m/1000).toFixed(1)} km`;
    }
    function haversine(lat1, lon1, lat2, lon2){
      const R = 6371e3;
      const toRad = d => d * Math.PI/180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    function placeIcon(tagset){
      // Lightweight icon seed based on category
      if (tagset.amenity === 'cinema') return 'üé¨';
      if (['restaurant','fast_food','cafe'].includes(tagset.amenity)) return 'üçΩÔ∏è';
      if (['bar','pub','nightclub'].includes(tagset.amenity)) return 'üç∏';
      if (tagset.leisure === 'playground') return 'üõù';
      if (tagset.leisure === 'park') return 'üå≥';
      if (tagset.tourism === 'theme_park') return 'üé°';
      if (tagset.tourism === 'zoo') return 'ü¶ì';
      if (tagset.tourism === 'aquarium') return 'üê†';
      if (tagset.tourism === 'viewpoint') return 'üì∏';
      return 'üìç';
    }
    function buildAddress(tags){
      const parts = [];
      if (tags['addr:housenumber']) parts.push(tags['addr:housenumber']);
      if (tags['addr:street']) parts.push(tags['addr:street']);
      const line1 = parts.join(' ');
      const cityParts = [tags['addr:city'] || tags['addr:town'] || tags['addr:village'] || '', tags['addr:postcode'] || ''].filter(Boolean);
      const line2 = cityParts.join(' ');
      return [line1, line2].filter(Boolean).join(', ');
    }
    function uniqueKey(lat, lon, name){
      const latr = Math.round(lat*100000)/100000;
      const lonr = Math.round(lon*100000)/100000;
      return `${latr},${lonr}:${(name||'').toLowerCase()}`;
    }

    // --- Overpass Query Builder ---
    function buildOverpassQuery(lat, lon, radius, category){
      const filters = CATEGORIES[category] || [];
      // No filters? bail
      if (!filters.length) return null;

      const perTag = filters.map(({k,v}) => `
        node["${k}"="${v}"](around:${radius},${lat},${lon});
        way["${k}"="${v}"](around:${radius},${lat},${lon});
        relation["${k}"="${v}"](around:${radius},${lat},${lon});
      `).join('\n');

      // Limit output to keep results snappy
      // out center gives a centroid for ways/relations
      return `
        [out:json][timeout:25];
        (
          ${perTag}
        );
        out tags center 200;
      `;
    }

    async function fetchOverpass(query){
      let lastErr;
      for (const ep of OVERPASS_ENDPOINTS){
        try{
          const res = await fetch(ep, {
            method:'POST',
            headers:{ 'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8' },
            body: 'data=' + encodeURIComponent(query)
          });
          if (!res.ok) throw new Error('HTTP '+res.status);
          const json = await res.json();
          return json;
        }catch(err){
          lastErr = err;
          // try next endpoint
        }
      }
      throw lastErr || new Error('Overpass unavailable');
    }

    function renderResults(items, origin){
      clearResults();
      if (!items || !items.length){
        resultsEl.innerHTML = `<div class="empty">No places found. Try increasing the radius or switching category.</div>`;
        return;
      }
      const frag = document.createDocumentFragment();
      for (const it of items){
        const card = document.createElement('div');
        card.className = 'card';

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = placeIcon(it.tags);

        const content = document.createElement('div');
        content.className = 'content';

        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = it.name || 'Unnamed place';

        const meta = document.createElement('div');
        meta.className = 'meta';
        const addr = it.address || '';
        meta.textContent = [addr, it.distanceText].filter(Boolean).join(' ‚Ä¢ ');

        const badges = document.createElement('div');
        badges.className = 'badges';
        const tagBadge = document.createElement('div');
        tagBadge.className = 'badge';
        tagBadge.textContent = it.kind;
        badges.appendChild(tagBadge);

        const actions = document.createElement('div');
        actions.className = 'actions';
        const maps = document.createElement('a');
        maps.className = 'btn primary';
        maps.href = `https://www.google.com/maps?q=${it.lat},${it.lon}`;
        maps.target = '_blank';
        maps.rel = 'noopener';
        maps.textContent = 'Open in Maps';

        const copyBtn = document.createElement('button');
        copyBtn.className = 'btn';
        copyBtn.textContent = 'Copy address';
        copyBtn.addEventListener('click', async () => {
          try{
            await navigator.clipboard.writeText(it.name + (it.address ? ' ‚Äî ' + it.address : '') );
            copyBtn.textContent = 'Copied!';
            setTimeout(()=> copyBtn.textContent = 'Copy address', 1200);
          }catch(e){
            alert('Copy failed');
          }
        });

        actions.appendChild(maps);
        actions.appendChild(copyBtn);

        content.appendChild(name);
        content.appendChild(meta);
        content.appendChild(badges);
        content.appendChild(actions);

        card.appendChild(avatar);
        card.appendChild(content);
        frag.appendChild(card);
      }
      resultsEl.appendChild(frag);

      const now = new Date();
      const radiusKm = (state.radius/1000).toFixed(1);
      metaEl.textContent = `${items.length} results ‚Ä¢ within ${radiusKm} km ‚Ä¢ ${now.toLocaleTimeString()}`;
    }

    function normalizeKind(tags){
      if (tags.amenity === 'cinema') return 'Cinema';
      if (tags.amenity === 'restaurant') return 'Restaurant';
      if (tags.amenity === 'fast_food') return 'Fast food';
      if (tags.amenity === 'cafe') return 'Cafe';
      if (tags.amenity === 'bar') return 'Bar';
      if (tags.amenity === 'pub') return 'Pub';
      if (tags.amenity === 'nightclub') return 'Nightclub';
      if (tags.leisure === 'playground') return 'Playground';
      if (tags.leisure === 'park') return 'Park';
      if (tags.tourism === 'theme_park') return 'Theme park';
      if (tags.tourism === 'zoo') return 'Zoo';
      if (tags.tourism === 'aquarium') return 'Aquarium';
      if (tags.tourism === 'viewpoint') return 'Viewpoint';
      return 'Place';
    }

    function processOverpass(data, origin){
      const list = [];
      const seen = new Set();
      for (const el of (data.elements || [])){
        const tags = el.tags || {};
        const lat = el.lat || (el.center && el.center.lat);
        const lon = el.lon || (el.center && el.center.lon);
        if (lat == null || lon == null) continue;

        const name = tags.name || null;
        const key = uniqueKey(lat, lon, name);
        if (seen.has(key)) continue;
        seen.add(key);

        const distance = haversine(origin.lat, origin.lon, lat, lon);
        list.push({
          id: el.id,
          lat, lon,
          name,
          address: buildAddress(tags),
          distance,
          distanceText: formatDistance(distance),
          kind: normalizeKind(tags),
          tags
        });
      }
      // Sort by distance, then by name
      list.sort((a,b)=> a.distance - b.distance || (a.name||'').localeCompare(b.name||''));
      return list;
    }

    async function searchAround(){
      if (state.lat == null || state.lon == null){
        setStatus(`<div class="error">Choose "Use my location" or enter an address to start.</div>`);
        return;
      }
      clearResults();
      setStatus(`
        <div class="loader">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
          <span>Searching ${state.category} within ${Math.round(state.radius/1000)} km‚Ä¶</span>
        </div>
      `);
      const q = buildOverpassQuery(state.lat, state.lon, state.radius, state.category);
      if (!q){
        setStatus(`<div class="error">No query for selected category.</div>`);
        return;
      }
      try{
        const data = await fetchOverpass(q);
        const items = processOverpass(data, { lat: state.lat, lon: state.lon });
        renderResults(items, { lat: state.lat, lon: state.lon });
        setStatus('');
      }catch(err){
        console.error(err);
        setStatus(`<div class="error">Couldn‚Äôt fetch results right now. Please try again or change radius/category.</div>`);
      }
    }

    // --- Geolocation & Geocoding ---
    async function geocode(query){
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
      const res = await fetch(url, { headers: { 'Accept':'application/json' } });
      if (!res.ok) throw new Error('Geocoding failed');
      const data = await res.json();
      if (!data.length) throw new Error('No matches');
      const best = data[0];
      return { lat: parseFloat(best.lat), lon: parseFloat(best.lon), display_name: best.display_name };
    }

    // --- Event wiring ---
    chips.forEach(chip=>{
      chip.addEventListener('click', ()=>{
        chips.forEach(c=> c.classList.remove('active'));
        chip.classList.add('active');
        state.category = chip.dataset.category;
        searchAround();
      });
    });
    radiusEl.addEventListener('change', ()=>{
      state.radius = parseInt(radiusEl.value,10);
      searchAround();
    });
    useLocationBtn.addEventListener('click', ()=>{
      if (!('geolocation' in navigator)){
        setStatus('<div class="error">Geolocation not supported on this device.</div>');
        return;
      }
      setStatus(`
        <div class="loader">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
          <span>Getting your location‚Ä¶</span>
        </div>
      `);
      navigator.geolocation.getCurrentPosition(pos=>{
        state.lat = pos.coords.latitude;
        state.lon = pos.coords.longitude;
        setStatus('');
        searchAround();
      }, err=>{
        setStatus(`<div class="error">Location blocked or unavailable. You can type an address instead.</div>`);
      }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
    });
    searchAddressBtn.addEventListener('click', async ()=>{
      const q = addressEl.value.trim();
      if (!q){ addressEl.focus(); return; }
      setStatus(`
        <div class="loader">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
          <span>Finding ‚Äú${q}‚Äù‚Ä¶</span>
        </div>
      `);
      try{
        const {lat, lon, display_name} = await geocode(q);
        state.lat = lat; state.lon = lon;
        setStatus(`<div class="small">Location set to: ${display_name}</div>`);
        searchAround();
      }catch(e){
        setStatus(`<div class="error">Couldn‚Äôt find that place. Try a city, neighborhood, or landmark.</div>`);
      }
    });

    // --- Sensible default: attempt geolocation on load (non-blocking) ---
    (function init(){
      // Don‚Äôt auto-search until we have a position
      if ('geolocation' in navigator){
        navigator.geolocation.getCurrentPosition(pos=>{
          state.lat = pos.coords.latitude;
          state.lon = pos.coords.longitude;
          searchAround();
        }, ()=>{/* ignore */});
      }
    })();
  </script>
</body>
</html>
